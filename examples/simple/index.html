<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="../cdn/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/simple.css">


  <!--<script type="text/javascript" src="../lib/call-signalling.js"></script>
  <script type="text/javascript" src="../lib/call-media.js"></script>
  <!--<script type="text/javascript" src="/lib/phone.js"></script>
  <script type="text/javascript" src="/lib/conference-view.js"></script>-->
</head>
<body data-state="loading">

  <table class="config" >
    <tr>
      <td colspan="4"><h4>Config: </h4></td>
    </tr>
    <tr>
      <td>Signaling:</td>
      <td>Endpoints:</td>
      <td>Media:</td>
      <td>Session:</td>
    </tr>
    <tr>
      <td><label><input type="radio" name="signaling" data-config="sio-signaling"/>socket.io signaling</label></td>
      <td><input type="text" data-config="sio-signaling-endpoint"/></td>
      <td><label><input type="radio" name="media" data-config="webrtc-media"/>webrtc media</label></td>
      <td rowspan="2">
        <!-- Service -->
        <table>
          <tr><td>service: </td><td><input type="text" data-config="service"/></td></tr>
          <tr><td>username:</td><td><input type="text" data-config="username"/></td></tr>
          <tr><td>password:</td><td><input type="text" data-config="password"/></td></tr>
        </table>
      </td>
    </tr>
    <tr>
      <td><label><input type="radio" name="signaling" data-config="flash-signaling" />flash (RTMP2JS) signaling</label></td>
      <td><textarea name="signaling" data-config="flash-signaling-endpoint"></textarea></td>
      <td><label><input type="radio" name="media" data-config="flash-media"/>Flash (MEDIA2JS) media</label></td>
    </tr>
  </table>

  <table class="controls">
    <tr>
      <td>
        <button id="init-all" class="btn btn-primary btn-small">init all</button><br/>
        <label><input type="checkbox" data-config="init-automatically"/>Init automatically</label>
      </td>
      <td>
        <button id="start" class="btn btn-success btn-small">start</button>
        <label id="signaling-status">Signaling NOT ready</label>
        <label id="media-status">Media NOT ready</label>
      </td>
      <td>
        <button id="connect" class="btn btn-success btn-small">connect</button><br/>
        <button id="disconnect" class="btn btn-danger btn-small">disconnect</button>
        <label id="connect-status">Disconnected</label>
      </td>
      <td>
        <button id="start-session" class="btn btn-success btn-small">start session</button><br/>
        <button class="btn btn-danger btn-small">stop session</button>
        <label id="session-status">Session NOT started</label>
      </td>
      <td>
        <button id="check-hardware" class="btn btn-success btn-small">check hardware</button><br/>
        <label id="hardware-status">NOT checked</label>
      </td>
    </tr>
  </table>

  <div class="call">
    <button id="start-call" class="btn btn-primary btn-small">start call</button>
    bUri: <input type="text" data-config="b-uri"/>
    <div class="vv">
      <label><input type="checkbox" data-config="vv-voice"/>voice</label>
      <label><input type="checkbox" data-config="vv-video"/>video</label>
    </div>
  </div>
  <div id="media-container" class="media-container">

  </div>

  <div id="communicator-graph">

  </div>

<!--
  <div id="conference-view" style="position:absolute; z-index:1; left:0; right:0; border:1px solid black; padding:0; margin:0; background: white;">
  </div>



  <div style="background: white; text-align: center; z-index:2; border:1px solid black; border-radius: 4px; line-height: 50px;font-weight: bold; position: absolute; right:0; top:0; font-size: 30px; width:100px; height: 50px;" id="log-phone"></div>
-->
  <!--<div class="sections-container" style="position:absolute; left:0; right:0; top:0; height:100%; max-height:600px; ">
	<section id="login" data-focus="#login-server">
		<div id="login-form">
			<label class="error">Ошибка</label>
			<label for="login-name">Логин</label>
			<input id="login-phone" type="text" value=""/>
			<label for="login-password">Пароль</label>
			<input id="login-password" type="text" value=""/>
			<br/>
			<input id="do-login" type="button" value="Войти"/> 
		</div>
	</section>

  <section id="loading">
    <img src="i/355.gif"/>
  </section>

  <section id="hardware-settings">
    ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑<br/>
    Разрешите доступ к камере и микрофону
    <style>
      .chrome-bar {
        width:100%;
        height: 25px;
        border:1px solid #aaaaab;
        text-align: left;
        margin-top:60px;
        background: -webkit-linear-gradient(top, #e5e5e5 0, #d9d9d9 100%);
        color: black;
        line-height: 25px;
        font-size: 10px;
      }
      .chrome-bar button {
        height: 18px;
        font-size: 10px;
        line-height:10px;
        border : 1px solid rgb(240, 240, 240);
        border-radius: 2px;
      }
      @-webkit-keyframes bounce {
        from {
          border-color: rgb(240, 240, 240);
        }
        to {
          border-color: red;
          
        }
      }
      .chrome-bar .allow {
        -webkit-animation-name: bounce;
        -webkit-animation-duration: 1s;
        -webkit-animation-iteration-count: 1000;
        -webkit-animation-direction: alternate;
      }
    </style>
    <div class="chrome-bar">
      <img src="i/chrome-mic.png" width="10"/>
      <span><script>document.write(location.hostname)</script> запрашивает разрешение на использование вашего микрофона</span>
      <button class="allow">Разрешить</button> <button>Запретить</button>
    </div>
  </section>
  <section id="app" data-focus="#dial-number">
    <div id="dtmf-block">
      <input type="text" id="dial-number"/>
      <div class="icon-remove-sign"></div>
      <input type="button" value="1"/>
      <input type="button" value="2"/>
      <input type="button" value="3"/>
      <input type="button" value="4"/>
      <input type="button" value="5"/>
      <input type="button" value="6"/>
      <input type="button" value="7"/>
      <input type="button" value="8"/>
      <input type="button" value="9"/>
      <input type="button" value="#"/>
      <input type="button" value="0"/>
      <input type="button" value="*"/>
      <button id="audio-call" class="start-call-button">Audio call</button>
      <button id="video-call" class="start-call-button">Video call</button>
      <br/>
      <button style="margin-top:50px;" id="audio-video-call" class="start-call-button">Audio-Video call</button>
    </div>
  </section>

  <section id="call-in-progress">
    <img src="i/call-in-progress.jpg" width="600"/><br/>
    <input type="button" value="Завершить" id="hangup-button" style="position:absolute; left: 50%; width:120px; margin-left:-60px;top:40px; height: 40px;"/>
  </section>
  
 	<section id="error">
		Ой, ошибка!
	</section>

  </div>

  <script>
    var conferenceView = new ConferenceView($('#conference-view'), 200);


    var remoteStreams = [];
    var localStreams = [];
    var phoneTimer = null;
    var stopTimer = function() {
      if(phoneTimer)  window.clearInterval(phoneTimer);
      phoneTimer = null;
    }
    var startTimer = function() {
      stopTimer();
      var s = new Date().valueOf();
      phoneTimer = window.setInterval(function() {
        var e = new Date().valueOf();
        $('#log-phone').html(Math.floor((e-s)/100)/10);
      },100);
    }

    var phone = new Phone({
      afterTransition: function(fromState, state, event, params) {
        console.log("Transition ", fromState, " -> ", state, " [event=", event, params,"]");
        switch(state) {
          case 'LOGIN':
            $('body').attr('data-state', 'login');
            $('#login-phone').focus();
            break;
          case 'LOGINING':
            $('body').attr('data-state', 'loading');
            break;
          case 'INITIALIZING_MEDIA':
          case 'HARDWARE_SETTINGS':
            $('body').attr('data-state', 'hardware-settings');
            break;
          case 'HARDWARE_SETTINGS_OK':
            $('body').attr('data-state', 'app');
            break;
        }
      },

      mediaEvent: function(eventName, opt) {
        switch(eventName) {
          case "media:add-local-stream":
            conferenceView.addLocalStream(opt);
            localStreams.push(opt);
            break;
          case "media:add-remote-stream":
            //var newStream = new webkitMediaStream(opt.getAudioTracks());
            var newStream  = opt;

            conferenceView.addRemoteStream(newStream);
            remoteStreams.push(newStream);
            break;

          case "media:remove-remote-stream":
            conferenceView.removeRemoteStream(opt);
            break;
        }
      },
      onChatMessage: function(o) {
        //...
      }
    });


    var call = null;

    var callListener = {
      afterTransition: function(fromState, state, event, params) {
        switch(state) {
          case "CALL_IN_PROGRESS":
            $('body').attr('data-state', 'call-in-progress');
            break;
          case "CALL_FINISHED":
            stopTimer();
            console.log("CALL FINISHED");
            $('body').attr('data-state', 'app');
            $('.start-call-button').prop('disabled', false);
            call = null;
            break;
          case "CALL_FAILED":
            stopTimer();
            break;
        }
      }
    };


    jQuery(function($){
      try {  $('#login-phone')   .val(window.localStorage.getItem('saved-login-phone'));     }catch(e) {}                  // saved phone-password
      try {  $('#login-password').val(window.localStorage.getItem('saved-login-password'));  }catch(e) {}

      /// TEST!!!!
      var $loginPhone = $('#login-phone')
      if(location.href.match(/phone=(\d+)/))
        $loginPhone.val(RegExp.$1);
      else
        $loginPhone.val(1000 + Math.floor(50*Math.random()));

      var $pwdField = $('#login-password');
      if(location.href.match(/pwd=(.+)(?:$|&)/))
        $pwdField.val(RegExp.$1);
      else
        $pwdField.val("1234");

      var $dialNumber = $('#dial-number')
      if(location.href.match(/to=(\d+)/))
        $dialNumber.val(RegExp.$1);


      $('#login-phone').focus().keydown(function(e){ if(e.keyCode === 13) $('#do-login').click() });
      $('#do-login').prop('disabled', false);

      $('#login-phone').on('input', function() { $('#do-login').prop('disabled', !$(this).val()); });

      $('#do-login').click(function() {
        $('#log-phone').text($('#login-phone').val());
        phone.event("ui:login", {phone: $('#login-phone').val(),  password:$('#login-password').val()});
        window.localStorage.setItem( 'saved-login-phone',    $('#login-phone').val()    );
        window.localStorage.setItem( 'saved-login-password', $('#login-password').val() );
      });

      $('#audio-call').click(function() {
        if(call) return;
        var b = $('#dial-number').val();
        console.log("Call on ", b);
        call = phone.startCall({bUri: b}, callListener);
        $('.start-call-button').prop('disabled', true);
        startTimer();
      });
      $('#video-call').click(function() {
        if(call) return;
        var b = $('#dial-number').val();
        console.log("Call on ", b);
        call = phone.startCall({bUri: b, vv: [false, true]}, callListener);
        $('.start-call-button').prop('disabled', true);
        startTimer();
      });
      $('#audio-video-call').click(function() {
        if(call) return;
        var b = $('#dial-number').val();
        console.log("Call on ", b);
        call = phone.startCall({bUri: b, vv: [true, true]}, callListener);
        $('.start-call-button').prop('disabled', true);
        startTimer();
      });

      $('#hangup-button').click(function(){
        if(call) {
          phone.hangup(call);
        }
      });

      $('#dtmf-block input[type="button"]').click(function() {
        var $field = $('#dtmf-block input[type="text"]');
        $field.val( $field.val() + $(this).val() ).focus();
      });

      $('#dtmf-block .icon-remove-sign').click(function() { $('#dtmf-block input[type="text"]').val('') });
    });
  </script>
  -->

  <script type="text/javascript" src="../cdn/jquery-1.9.0.min.js"></script>
  <script type="text/javascript" src="../cdn/bootstrap.min.js"></script>
  <script type="text/javascript" src="../cdn/socket.io-0.9.16.js"></script>
  <script type="text/javascript" src="../cdn/swfobject-2.2.js"></script>
  <script type="text/javascript" src="../cdn/raphael-2.1.2.min.js"></script>

  <script>
    window.DEBUG = true;
    window.LOG = console.log.bind(console);
  </script>

  <script type="text/javascript" src="a/config.js"></script>
  <script type="text/javascript" src="a/signaling.js"></script>
  <script type="text/javascript" src="a/media.js"></script>
  <script type="text/javascript" src="a/communicator.js"></script>
  <script type="text/javascript" src="a/main.js"></script>



</body>
</html>






